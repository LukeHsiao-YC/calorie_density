<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- SEO èˆ‡ ç¤¾ç¾¤åˆ†äº«è¨­å®š (ç™¼ä½ˆå¿…å‚™) -->
    <title>çœŸå¯¦ä»½é‡é£½è¶³æ„ŸæŒ‘æˆ° - æ‚¨åƒå°äº†å—ï¼Ÿ</title>
    <meta name="description" content="ä¸€å€‹äº’å‹•å¼çš„å°éŠæˆ²ï¼Œå¸¶æ‚¨é«”é©—ã€Œç†±é‡å¯†åº¦ã€å°é£½è¶³æ„Ÿçš„å½±éŸ¿ã€‚è©¦è©¦çœ‹ï¼Œåƒé£½è¦èŠ±å¤šå°‘ç†±é‡ï¼Ÿ">
    <meta property="og:title" content="çœŸå¯¦ä»½é‡é£½è¶³æ„ŸæŒ‘æˆ°">
    <meta property="og:description" content="ç›®æ¨™æ˜¯åƒåˆ°é£½è¶³ (600g)ï¼Œä½†ç†±é‡ä¸èƒ½çˆ†è¡¨ï¼å¿«ä¾†æŒ‘æˆ°ä½ çš„é£²é£Ÿé¸æ“‡ã€‚">
    <meta property="og:type" content="website">
    
    <!-- ç¶²ç«™åœ–ç¤º (Favicon) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ½ï¸</text></svg>">

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        
        body { font-family: 'Noto Sans TC', sans-serif; }

        .stomach-container {
            position: relative;
            overflow: hidden;
            transition: all 0.5s ease;
        }

        .food-item:active { transform: scale(0.95); }

        .fill-liquid {
            transition: height 0.5s ease-out, background-color 0.5s ease;
        }

        /* æ¨¡æ“¬é£Ÿç‰©æ‰è½å‹•ç•« */
        @keyframes dropIn {
            0% { transform: translateY(-100px) rotate(0deg); opacity: 0; }
            60% { transform: translateY(10px) rotate(10deg); opacity: 1; }
            100% { transform: translateY(0) rotate(0deg); opacity: 1; }
        }
        .food-drop { 
            animation: dropIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; 
            transform-origin: center bottom;
        }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-gray-800 flex flex-col">

    <div class="flex-1 w-full max-w-6xl mx-auto p-2 md:p-4">
        <!-- Header -->
        <header class="text-center mb-4">
            <h1 class="text-2xl md:text-3xl font-bold text-slate-800">ğŸ½ï¸ çœŸå¯¦ä»½é‡é£½è¶³æ„ŸæŒ‘æˆ°</h1>
            <p class="text-gray-600 text-sm mt-1">
                ç›®æ¨™ï¼šåƒåˆ° <span class="font-bold text-teal-600">é£½è¶³ (600g)</span>ã€‚
                <br class="md:hidden">é¸æ“‡å¹³å¸¸åƒçš„ã€Œä¸€ä»½ã€é£Ÿç‰©ï¼Œçœ‹çœ‹ç†±é‡æœƒç™¼ç”Ÿä»€éº¼äº‹ï¼Ÿ
            </p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <!-- Left Panel: The Stomach & Stats (Occupies 4 cols) -->
            <div class="lg:col-span-4 flex flex-col gap-4">
                <div class="bg-white p-5 rounded-2xl shadow-md border border-gray-200 flex flex-col items-center sticky top-4">
                    <h3 class="text-lg font-semibold mb-2 text-gray-700">èƒƒéƒ¨ç‹€æ…‹ (é«”ç©å¯è¦–åŒ–)</h3>
                    
                    <!-- Stomach Visualization -->
                    <div class="relative w-56 h-72 border-4 border-gray-300 rounded-b-[4rem] rounded-t-lg bg-gray-100 overflow-hidden shadow-inner stomach-container mb-4">
                        <div class="absolute inset-0 z-0 opacity-20" style="background-image: linear-gradient(#ccc 1px, transparent 1px); background-size: 100% 20%;"></div>
                        
                        <!-- The Fill Level -->
                        <div id="stomachFill" class="absolute bottom-0 left-0 w-full bg-teal-400 opacity-80 fill-liquid flex items-end justify-center z-10" style="height: 0%;">
                            <span id="fillPercentage" class="text-white font-bold text-xl pb-2 drop-shadow-md">0%</span>
                        </div>

                        <!-- Emojis Container -->
                        <div id="foodVisuals" class="absolute bottom-0 w-full h-full pointer-events-none z-20 flex flex-col-reverse flex-wrap content-center justify-center p-2 gap-1 overflow-hidden"></div>
                    </div>

                    <!-- Dashboard -->
                    <div class="w-full space-y-4">
                        <!-- Weight Bar (Visible) -->
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span>é£½è¶³é€²åº¦ (é‡é‡)</span>
                                <span id="weightText" class="font-mono font-bold">0g / 600g</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                                <div id="weightBar" class="bg-teal-500 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                            </div>
                        </div>

                        <!-- Calorie Bar (Hidden initially) -->
                        <div id="calorieSection" class="relative">
                            <div class="flex justify-between text-sm mb-1 opacity-50 filter blur-[2px]">
                                <span>ç´¯ç©ç†±é‡</span>
                                <span class="font-mono font-bold">??? kcal</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden opacity-50">
                                <div class="bg-red-400 h-3 rounded-full w-0"></div>
                            </div>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <span class="bg-gray-800 text-white text-xs px-2 py-1 rounded shadow">æŒ‘æˆ°çµæŸå¾Œæ­æ›‰</span>
                            </div>
                        </div>
                    </div>

                    <!-- Reset Button -->
                    <button onclick="resetGame()" class="mt-6 w-full py-2 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-lg transition text-sm font-semibold">
                        é‡ç½®æŒ‘æˆ°
                    </button>
                </div>
            </div>

            <!-- Right Panel: Food Menu (Occupies 8 cols) -->
            <div class="lg:col-span-8 bg-white rounded-2xl shadow-md border border-gray-200 flex flex-col overflow-hidden max-h-[85vh]">
                <!-- Tabs -->
                <div class="flex overflow-x-auto border-b border-gray-200 hide-scrollbar p-2 gap-2 bg-gray-50 flex-shrink-0" id="categoryTabs">
                    <button onclick="filterFood('all')" class="tab-btn px-4 py-2 rounded-full text-sm font-medium bg-teal-600 text-white shadow-sm whitespace-nowrap">å…¨éƒ¨</button>
                    <button onclick="filterFood('veg_fruit')" class="tab-btn px-4 py-2 rounded-full text-sm font-medium bg-white text-gray-600 hover:bg-gray-100 whitespace-nowrap">è”¬æœé¡</button>
                    <button onclick="filterFood('starch')" class="tab-btn px-4 py-2 rounded-full text-sm font-medium bg-white text-gray-600 hover:bg-gray-100 whitespace-nowrap">æ¾±ç²‰ä¸»é£Ÿ</button>
                    <button onclick="filterFood('protein')" class="tab-btn px-4 py-2 rounded-full text-sm font-medium bg-white text-gray-600 hover:bg-gray-100 whitespace-nowrap">è›‹ç™½è³ª</button>
                    <button onclick="filterFood('snack')" class="tab-btn px-4 py-2 rounded-full text-sm font-medium bg-white text-gray-600 hover:bg-gray-100 whitespace-nowrap">é›¶é£Ÿ/é£²æ–™</button>
                </div>

                <!-- Food Grid -->
                <div class="flex-1 overflow-y-auto p-4 bg-gray-50">
                    <div class="text-xs text-gray-500 mb-2 bg-blue-50 p-2 rounded border border-blue-100">
                        ğŸ’¡ æç¤ºï¼šé»æ“ŠåŠ å…¥<b>ã€Œä¸€ä»½çœŸå¯¦ä»½é‡ã€</b>ã€‚è«‹ä¾ç…§æ‚¨å¹³å¸¸çš„é£Ÿé‡é»é¸ã€‚
                    </div>
                    <div id="foodGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3 pb-20">
                        <!-- Items injected by JS -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Result Modal Overlay -->
    <div id="resultModal" class="fixed inset-0 bg-black/80 z-50 hidden flex items-end md:items-center justify-center p-0 md:p-4 backdrop-blur-sm overflow-y-auto">
        <div class="bg-white rounded-t-2xl md:rounded-2xl w-full max-w-2xl p-6 shadow-2xl relative flex flex-col max-h-[90vh]">
            <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-2xl">âœ•</button>
            
            <!-- Result Header -->
            <div class="text-center mb-6">
                <div id="resultIcon" class="inline-block p-3 rounded-full bg-teal-100 text-4xl mb-2">ğŸ‰</div>
                <h2 class="text-2xl font-bold text-gray-800">é£½è¶³æ„Ÿé”æˆï¼</h2>
                <div class="flex items-center justify-center gap-4 mt-2">
                    <div class="text-center">
                        <div class="text-xs text-gray-500">ç¸½é‡é‡</div>
                        <div id="finalWeight" class="text-lg font-bold text-gray-700">0g</div>
                    </div>
                    <div class="h-8 w-px bg-gray-300"></div>
                    <div class="text-center">
                        <div class="text-xs text-gray-500">ç¸½ç†±é‡</div>
                        <div id="finalScore" class="text-3xl font-black text-teal-600">0</div>
                    </div>
                </div>
                <div id="scoreEvaluation" class="text-sm font-bold px-3 py-1 rounded-full bg-gray-100 mt-2 inline-block">è¨ˆç®—ä¸­</div>
            </div>

            <!-- Analysis List -->
            <div class="flex-1 overflow-y-auto border-t border-b border-gray-100 py-4 mb-4">
                <h3 class="text-sm font-bold text-gray-700 mb-3">æ‚¨çš„èœå–®åˆ†æ (ç†±é‡å¯†åº¦æ­å¯†)</h3>
                <div class="grid grid-cols-4 text-xs text-gray-400 border-b pb-2 mb-2 px-2">
                    <div class="col-span-2">é£Ÿç‰©åç¨±</div>
                    <div class="text-right">ä»½é‡/ç†±é‡</div>
                    <div class="text-right">å¯†åº¦(cal/g)</div>
                </div>
                <div id="receiptList" class="space-y-3">
                    <!-- Receipt items injected by JS -->
                </div>
            </div>

            <!-- Actions -->
            <div class="flex gap-3 mt-auto">
                <button onclick="resetGame()" class="flex-1 py-3 bg-teal-600 hover:bg-teal-700 text-white rounded-xl font-bold shadow-lg transition">å†æ¬¡æŒ‘æˆ°</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. Data Source (Real Serving Sizes) ---
        // Density = serving_cal / serving_g
        const foods = [
            // --- è”¬æœé¡ ---
            { id: 'lettuce', name: 'ç”Ÿèœæ²™æ‹‰', serving_desc: '1ç›¤', serving_g: 150, serving_cal: 25, emoji: 'ğŸ¥—', category: 'veg_fruit' },
            { id: 'broccoli', name: 'ç‡™èŠ±æ¤°èœ', serving_desc: '1ä»½', serving_g: 100, serving_cal: 34, emoji: 'ğŸ¥¦', category: 'veg_fruit' },
            { id: 'veg_stir_fry', name: 'ç‚’é’èœ', serving_desc: '1ç›¤', serving_g: 150, serving_cal: 120, emoji: 'ğŸ¥¬', category: 'veg_fruit' }, // æ²¹è„‚å¢åŠ ç†±é‡
            { id: 'veg_tempura', name: 'ç‚¸è”¬èœå¤©å©¦ç¾…', serving_desc: '1ä»½', serving_g: 120, serving_cal: 280, emoji: 'ğŸ¤', category: 'veg_fruit' }, // ç‚¸éºµè¡£å¸æ²¹
            { id: 'apple', name: 'è˜‹æœ', serving_desc: '1é¡†', serving_g: 150, serving_cal: 78, emoji: 'ğŸ', category: 'veg_fruit' },
            { id: 'banana', name: 'é¦™è•‰', serving_desc: '1æ ¹', serving_g: 120, serving_cal: 105, emoji: 'ğŸŒ', category: 'veg_fruit' },
            { id: 'guava', name: 'èŠ­æ¨‚', serving_desc: '1é¡†', serving_g: 300, serving_cal: 114, emoji: 'ğŸ', category: 'veg_fruit' },

            // --- æ¾±ç²‰ä¸»é£Ÿ ---
            { id: 'oatmeal', name: 'å¤§ç‡•éº¥ç‰‡', serving_desc: '1ç¢—', serving_g: 250, serving_cal: 150, emoji: 'ğŸ¥£', category: 'starch' },
            { id: 'sweet_potato', name: 'åœ°ç“œ', serving_desc: '1æ¢', serving_g: 150, serving_cal: 180, emoji: 'ğŸ ', category: 'starch' },
            { id: 'potato', name: 'é¦¬éˆ´è–¯', serving_desc: '1é¡†', serving_g: 150, serving_cal: 120, emoji: 'ğŸ¥”', category: 'starch' },
            { id: 'rice', name: 'ç™½é£¯', serving_desc: '1ç¢—', serving_g: 200, serving_cal: 280, emoji: 'ğŸš', category: 'starch' },
            { id: 'thick_soup_rice', name: 'è‚‰ç¾¹é£¯', serving_desc: '1ç¢—', serving_g: 400, serving_cal: 450, emoji: 'ğŸ²', category: 'starch' }, // æ°´åˆ†å¤šä½†å‹¾èŠ¡
            { id: 'oil_rice', name: 'æ²¹é£¯', serving_desc: '1ç¢—', serving_g: 200, serving_cal: 400, emoji: 'ğŸš', category: 'starch' },
            { id: 'fried_rice', name: 'ç‚’é£¯', serving_desc: '1ç›¤', serving_g: 300, serving_cal: 600, emoji: 'ğŸ›', category: 'starch' },
            { id: 'fried_noodle', name: 'ç‚’éºµ', serving_desc: '1ç›¤', serving_g: 300, serving_cal: 550, emoji: 'ğŸ', category: 'starch' },
            { id: 'olive_pasta', name: 'æ¸…ç‚’ç¾©å¤§éºµ', serving_desc: '1ç›¤', serving_g: 300, serving_cal: 480, emoji: 'ğŸ', category: 'starch' },
            { id: 'pesto_pasta', name: 'é’é†¬ç¾©å¤§éºµ', serving_desc: '1ç›¤', serving_g: 350, serving_cal: 650, emoji: 'ğŸ', category: 'starch' },
            { id: 'cream_pasta', name: 'å¥¶æ²¹ç¾©å¤§éºµ', serving_desc: '1ç›¤', serving_g: 350, serving_cal: 750, emoji: 'ğŸ', category: 'starch' },
            { id: 'sesame_noodle', name: 'éº»é†¬éºµ', serving_desc: '1ç¢—', serving_g: 250, serving_cal: 500, emoji: 'ğŸœ', category: 'starch' },
            { id: 'dry_noodle', name: 'ä¹¾éºµ', serving_desc: '1ç¢—', serving_g: 200, serving_cal: 350, emoji: 'ğŸœ', category: 'starch' },
            { id: 'burger', name: 'æ¼¢å ¡', serving_desc: '1å€‹', serving_g: 180, serving_cal: 450, emoji: 'ğŸ”', category: 'starch' },
            { id: 'clay_roll', name: 'ç‡’é¤…', serving_desc: '1å€‹', serving_g: 80, serving_cal: 300, emoji: 'ğŸ¥¯', category: 'starch' }, // é…¥çš®æ²¹å¤š
            { id: 'milk_bread', name: 'å¥¶é…¥éºµåŒ…', serving_desc: '1å€‹', serving_g: 100, serving_cal: 380, emoji: 'ğŸ¥', category: 'starch' },
            { id: 'fries_m', name: 'ä¸­è–¯', serving_desc: '1åŒ…', serving_g: 100, serving_cal: 310, emoji: 'ğŸŸ', category: 'starch' },

            // --- è›‹ç™½è³ª ---
            { id: 'egg', name: 'æ°´ç…®è›‹', serving_desc: '1é¡†', serving_g: 50, serving_cal: 70, emoji: 'ğŸ¥š', category: 'protein' },
            { id: 'milk', name: 'ç‰›å¥¶', serving_desc: '1æ¯', serving_g: 240, serving_cal: 150, emoji: 'ğŸ¥›', category: 'protein' },
            { id: 'steam_fish', name: 'æ¸…è’¸é­š', serving_desc: '1ç‰‡', serving_g: 150, serving_cal: 180, emoji: 'ğŸŸ', category: 'protein' },
            { id: 'squid', name: 'ç‡™èŠ±æ', serving_desc: '1ç›¤', serving_g: 120, serving_cal: 100, emoji: 'ğŸ¦‘', category: 'protein' },
            { id: 'tuna_salad', name: 'é®ªé­šæ²™æ‹‰', serving_desc: '1ä»½', serving_g: 120, serving_cal: 260, emoji: 'ğŸ¥—', category: 'protein' },
            { id: 'chicken_breast', name: 'é›èƒ¸è‚‰', serving_desc: '1ç‰‡', serving_g: 150, serving_cal: 248, emoji: 'ğŸ—', category: 'protein' },
            { id: 'braised_pork', name: 'æ»·æ’éª¨', serving_desc: '1å¡Š', serving_g: 150, serving_cal: 320, emoji: 'ğŸ–', category: 'protein' },
            { id: 'fried_pork', name: 'ç‚¸è±¬æ’', serving_desc: '1å¡Š', serving_g: 150, serving_cal: 450, emoji: 'ğŸ–', category: 'protein' },
            { id: 'steak', name: 'ç‰›æ’', serving_desc: '1å¡Š', serving_g: 200, serving_cal: 500, emoji: 'ğŸ¥©', category: 'protein' },
            { id: 'pork_belly', name: 'äº”èŠ±è‚‰', serving_desc: '1ä»½', serving_g: 100, serving_cal: 400, emoji: 'ğŸ¥“', category: 'protein' },
            { id: 'sausage', name: 'é¦™è…¸', serving_desc: '1æ ¹', serving_g: 50, serving_cal: 200, emoji: 'ğŸŒ­', category: 'protein' },
            { id: 'ham', name: 'ç«è…¿', serving_desc: '1ç‰‡', serving_g: 30, serving_cal: 50, emoji: 'ğŸ¥©', category: 'protein' },
            { id: 'bacon_slice', name: 'åŸ¹æ ¹', serving_desc: '1ç‰‡', serving_g: 30, serving_cal: 160, emoji: 'ğŸ¥“', category: 'protein' },
            { id: 'chicken_skin', name: 'ç‚¸é›çš®', serving_desc: '1ä¸²', serving_g: 50, serving_cal: 250, emoji: 'ğŸ¢', category: 'protein' },

            // --- é›¶é£Ÿ/é£²æ–™ ---
            { id: 'coke_zero', name: 'é›¶å¡å¯æ¨‚', serving_desc: '1ç½', serving_g: 330, serving_cal: 0, emoji: 'ğŸ¥¤', category: 'snack' },
            { id: 'juice', name: '100%ç´”æœæ±', serving_desc: '1æ¯', serving_g: 250, serving_cal: 120, emoji: 'ğŸ§ƒ', category: 'snack' },
            { id: 'yogurt', name: 'å„ªæ ¼', serving_desc: '1æ¯', serving_g: 150, serving_cal: 140, emoji: 'ğŸ¥£', category: 'snack' },
            { id: 'dried_squid', name: 'é­·é­šçµ²', serving_desc: '1æŠŠ', serving_g: 30, serving_cal: 85, emoji: 'ğŸ¦‘', category: 'snack' },
            { id: 'half_sugar_tea', name: 'åŠç³–çå¥¶', serving_desc: '1æ¯', serving_g: 700, serving_cal: 500, emoji: 'ğŸ§‹', category: 'snack' },
            { id: 'bubble_tea', name: 'å…¨ç³–çå¥¶', serving_desc: '1æ¯', serving_g: 700, serving_cal: 700, emoji: 'ğŸ¥¤', category: 'snack' },
            { id: 'raisins', name: 'è‘¡è„ä¹¾', serving_desc: '1æŠŠ', serving_g: 30, serving_cal: 90, emoji: 'ğŸ‡', category: 'snack' },
            { id: 'nuts', name: 'å …æœ', serving_desc: '1æŠŠ', serving_g: 30, serving_cal: 180, emoji: 'ğŸ¥œ', category: 'snack' },
            { id: 'chips', name: 'æ´‹èŠ‹ç‰‡', serving_desc: '1åŒ…', serving_g: 60, serving_cal: 320, emoji: 'ğŸª', category: 'snack' },
            { id: 'cake', name: 'åˆ‡ç‰‡è›‹ç³•', serving_desc: '1ç‰‡', serving_g: 80, serving_cal: 280, emoji: 'ğŸ°', category: 'snack' },
            { id: 'chocolate', name: 'å·§å…‹åŠ›', serving_desc: '1æ¢', serving_g: 45, serving_cal: 240, emoji: 'ğŸ«', category: 'snack' },
            { id: 'cheese', name: 'èµ·å¸', serving_desc: '1ç‰‡', serving_g: 20, serving_cal: 65, emoji: 'ğŸ§€', category: 'snack' },
            { id: 'thousand_island', name: 'åƒå³¶é†¬', serving_desc: '1åŒ™', serving_g: 15, serving_cal: 80, emoji: 'ğŸ¥£', category: 'snack' },
            { id: 'peanut_butter', name: 'èŠ±ç”Ÿé†¬', serving_desc: '1åŒ™', serving_g: 15, serving_cal: 95, emoji: 'ğŸ¥œ', category: 'snack' },
            { id: 'oil', name: 'æ·‹æ²¹/é†¬æ±', serving_desc: '1æ¹¯åŒ™', serving_g: 15, serving_cal: 130, emoji: 'ğŸ§ˆ', category: 'snack' }
        ];

        // --- 2. Game State ---
        const SATIETY_GOAL = 600; 
        let currentCal = 0;
        let currentWeight = 0;
        let isGameOver = false;
        let eatenHistory = []; 

        // --- 3. Initialization ---
        function init() {
            renderFoodGrid('all');
        }

        function filterFood(cat) {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('bg-teal-600', 'text-white');
                btn.classList.add('bg-white', 'text-gray-600');
            });
            event.target.classList.remove('bg-white', 'text-gray-600');
            event.target.classList.add('bg-teal-600', 'text-white');
            renderFoodGrid(cat);
        }

        function renderFoodGrid(category) {
            const grid = document.getElementById('foodGrid');
            grid.innerHTML = '';
            const filtered = category === 'all' ? foods : foods.filter(f => f.category === category);

            filtered.forEach(item => {
                const btn = document.createElement('button');
                btn.className = 'food-item bg-white p-2 rounded-xl border border-gray-200 shadow-sm hover:shadow-md hover:border-teal-300 flex flex-col items-center justify-center gap-1 h-32 transition relative overflow-hidden';
                btn.onclick = () => eatFood(item);
                btn.innerHTML = `
                    <div class="text-3xl mb-1">${item.emoji}</div>
                    <div class="text-sm font-bold text-gray-800 text-center leading-tight px-1 break-words w-full">${item.name}</div>
                    <div class="text-[10px] text-teal-600 font-medium bg-teal-50 px-2 py-0.5 rounded-full mt-1">${item.serving_desc}</div>
                `;
                grid.appendChild(btn);
            });
        }

        // --- 4. Game Logic ---
        function eatFood(item) {
            if (isGameOver) return;

            currentCal += item.serving_cal;
            currentWeight += item.serving_g;
            
            // Add to history
            const existingItem = eatenHistory.find(h => h.id === item.id);
            if (existingItem) {
                existingItem.count++;
                existingItem.totalWeight += item.serving_g;
                existingItem.totalCal += item.serving_cal;
            } else {
                eatenHistory.push({
                    ...item,
                    count: 1,
                    totalWeight: item.serving_g,
                    totalCal: item.serving_cal
                });
            }

            // Visuals
            addVisuals(item);
            updateDashboard();

            if (currentWeight >= SATIETY_GOAL) {
                setTimeout(endGame, 600); 
            }
        }

        function addVisuals(item) {
            const container = document.getElementById('foodVisuals');
            
            // Visual scale based on Weight (Volume)
            const baseScale = 0.5;
            const weightFactor = item.serving_g / 80; 
            let scale = baseScale + (weightFactor * 0.4);
            if (scale > 2.8) scale = 2.8;
            if (scale < 0.4) scale = 0.4;

            const el = document.createElement('span');
            el.textContent = item.emoji;
            el.className = 'absolute text-xl food-drop select-none';
            el.style.left = Math.random() * 80 + 10 + '%';
            el.style.fontSize = '2rem';
            el.style.transform = `scale(${scale})`;
            el.style.zIndex = Math.floor(Math.random() * 10);
            
            container.appendChild(el);
        }

        function updateDashboard() {
            const weightPct = Math.min((currentWeight / SATIETY_GOAL) * 100, 100);
            document.getElementById('weightText').innerText = `${currentWeight}g / ${SATIETY_GOAL}g`;
            document.getElementById('weightBar').style.width = `${weightPct}%`;
            document.getElementById('stomachFill').style.height = `${weightPct}%`;
            document.getElementById('fillPercentage').innerText = `${Math.round(weightPct)}%`;
        }

        function endGame() {
            isGameOver = true;
            const modal = document.getElementById('resultModal');
            const scoreEl = document.getElementById('finalScore');
            const weightEl = document.getElementById('finalWeight');
            const evalEl = document.getElementById('scoreEvaluation');
            const receiptEl = document.getElementById('receiptList');
            const iconEl = document.getElementById('resultIcon');

            modal.classList.remove('hidden');
            scoreEl.innerHTML = `${currentCal} <span class="text-sm text-gray-500">kcal</span>`;
            weightEl.innerText = `${currentWeight}g`;

            // Evaluation for a meal (Standard)
            // <= 700 Excellent
            // 701 - 1000 Normal
            // > 1000 High
            if (currentCal <= 700) {
                iconEl.innerText = "ğŸ†";
                evalEl.innerText = "è¼•ç›ˆé£½è¶³ (Excellent)";
                evalEl.className = "text-sm font-bold px-4 py-1 rounded-full bg-green-100 text-green-700 mt-2 inline-block";
                scoreEl.className = "text-3xl font-black text-green-600";
            } else if (currentCal <= 1000) {
                iconEl.innerText = "ğŸ‘Œ";
                evalEl.innerText = "æ­£å¸¸ä¸€é¤ (Normal)";
                evalEl.className = "text-sm font-bold px-4 py-1 rounded-full bg-yellow-100 text-yellow-700 mt-2 inline-block";
                scoreEl.className = "text-3xl font-black text-yellow-600";
            } else {
                iconEl.innerText = "âš ï¸";
                evalEl.innerText = "ç†±é‡è¶…æ¨™ (High)";
                evalEl.className = "text-sm font-bold px-4 py-1 rounded-full bg-red-100 text-red-700 mt-2 inline-block";
                scoreEl.className = "text-3xl font-black text-red-600";
            }

            // Generate Detailed Receipt
            receiptEl.innerHTML = '';
            
            // Sort by Density descending to show the "bad" ones first
            const sortedHistory = [...eatenHistory].sort((a,b) => (b.serving_cal/b.serving_g) - (a.serving_cal/a.serving_g));

            sortedHistory.forEach(item => {
                const row = document.createElement('div');
                row.className = "bg-slate-50 p-3 rounded-lg border border-slate-100 flex items-center justify-between";
                
                // Calculate Density
                const density = (item.serving_cal / item.serving_g).toFixed(1);
                
                // Density Color Grading
                let densityColor = "text-gray-400";
                let densityLabel = "ä½";
                let densityBg = "";
                
                // Special handling for Zero Calorie
                if (item.serving_cal === 0) {
                     densityColor = "text-green-600"; 
                     densityLabel = "ç„¡ç†±é‡";
                } else if(density > 4.0) { 
                    densityColor = "text-red-500 font-bold"; densityLabel = "æ¥µé«˜"; densityBg = "bg-red-50";
                } else if(density > 2.0) { 
                    densityColor = "text-orange-500"; densityLabel = "é«˜"; 
                } else if(density > 1.0) { 
                    densityColor = "text-yellow-600"; densityLabel = "ä¸­"; 
                } else { 
                    densityColor = "text-green-600"; densityLabel = "ä½"; 
                }

                if (densityBg) row.classList.add(densityBg);

                row.innerHTML = `
                    <div class="flex items-center gap-3 col-span-2 flex-1">
                        <div class="text-2xl">${item.emoji}</div>
                        <div>
                            <div class="font-bold text-gray-800 text-sm">${item.name}</div>
                            <div class="text-xs text-gray-500">x${item.count} ${item.serving_desc}</div>
                        </div>
                    </div>
                    
                    <div class="text-right w-24">
                        <div class="text-sm font-bold text-gray-700">${item.totalWeight}g</div>
                        <div class="text-xs text-gray-500">${item.totalCal} kcal</div>
                    </div>

                    <div class="text-right w-20 pl-2 border-l border-gray-200 ml-2">
                        <div class="text-sm ${densityColor}">${density}</div>
                        <div class="text-[10px] text-gray-400">å¯†åº¦(${densityLabel})</div>
                    </div>
                `;
                receiptEl.appendChild(row);
            });

            // Reveal Calorie Bar on Main Dashboard
            const calSection = document.getElementById('calorieSection');
            calSection.innerHTML = `
                <div class="flex justify-between text-sm mb-1">
                    <span>æœ€çµ‚ç†±é‡</span>
                    <span class="font-mono font-bold ${currentCal > 1000 ? 'text-red-600' : 'text-green-600'}">${currentCal} kcal</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                    <div class="${currentCal > 1000 ? 'bg-red-500' : 'bg-green-500'} h-3 rounded-full" style="width: 100%"></div>
                </div>
            `;
        }

        function closeModal() {
            document.getElementById('resultModal').classList.add('hidden');
        }

        function resetGame() {
            currentCal = 0;
            currentWeight = 0;
            isGameOver = false;
            eatenHistory = [];
            
            document.getElementById('foodVisuals').innerHTML = '';
            document.getElementById('stomachFill').style.height = '0%';
            document.getElementById('fillPercentage').innerText = '0%';
            document.getElementById('weightBar').style.width = '0%';
            document.getElementById('weightText').innerText = '0g / 600g';
            
            document.getElementById('calorieSection').innerHTML = `
                <div class="flex justify-between text-sm mb-1 opacity-50 filter blur-[2px]">
                    <span>ç´¯ç©ç†±é‡</span>
                    <span class="font-mono font-bold">??? kcal</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden opacity-50">
                    <div class="bg-red-400 h-3 rounded-full w-0"></div>
                </div>
                <div class="absolute inset-0 flex items-center justify-center">
                    <span class="bg-gray-800 text-white text-xs px-2 py-1 rounded shadow">æŒ‘æˆ°çµæŸå¾Œæ­æ›‰</span>
                </div>
            `;
            closeModal();
        }

        init();
    </script>
</body>
</html>